# In order to execute the below `vagrant ssh` command, we must be in the directory
# of the Vagrantfile.
cd "$EMULATE_VAGRANT_PATH"

# Determine the path to the bash script containing the body of "this" run step.
# Unfortunately, because macos-10.15 is using an older version of Bash (3.2),
# we cannot use its newer array subscripting features yet.
RUN_SCRIPT="$(ps -p $$ -o args= | xargs -n 1 | tail -n 1)"

# Proxy the body of the run step to the guest virtual machine.
# It's important that this is `exec`uted, because this is what cause this BASH_ENV
# script to "hijack" the original script's execution. Without the `exec`, $RUN_SCRIPT
# would also execute in the host.
VAGRANT_HOME="$RUNNER_TEMP/vagrant" exec vagrant ssh -c 'exec $SHELL -se' < "$RUN_SCRIPT"
